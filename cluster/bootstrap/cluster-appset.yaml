apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: cluster
  namespace: core-argocd
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    - git:
        repoURL: git@github.com:FailureToLoad/homelab-cluster.git
        revision: main
        directories:
          - path: cluster/platform/*
        values:
          tier: "1"
    - git:
        repoURL: git@github.com:FailureToLoad/homelab-cluster.git
        revision: main
        directories:
          - path: cluster/core/*
        values:
          tier: "2"
    - git:
        repoURL: git@github.com:FailureToLoad/homelab-cluster.git
        revision: main
        directories:
          - path: cluster/observe/*
        values:
          tier: "3"
    - git:
        repoURL: git@github.com:FailureToLoad/homelab-cluster.git
        revision: main
        directories:
          - path: cluster/app/*
        values:
          tier: "4"
  template:
    metadata:
      name: "{{ .path.basename }}"
      labels:
        tier: "{{ .values.tier }}"
    spec:
      project: default
      source:
        repoURL: git@github.com:FailureToLoad/homelab-cluster.git
        targetRevision: main
        path: "{{ .path.path }}"
      destination:
        name: in-cluster
        namespace: core-argocd
      syncPolicy:
        syncOptions:
          - ServerSideApply=true
          - RespectIgnoreDifferences=true
        retry:
          limit: 3
          backoff:
            duration: 10s
            factor: 2
            maxDuration: 3m
  syncPolicy:
    applicationsSync: create-update
