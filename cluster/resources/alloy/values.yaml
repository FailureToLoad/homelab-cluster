commonLabels:
  app.kubernetes.io/name: alloy

alloy:
  configMap:
    content: |
      discovery.kubernetes "pods" {
        role = "pod"
      }
      
      discovery.kubernetes "nodes" {
        role = "node"
      }
      
      discovery.relabel "pod_labels" {
        targets = discovery.kubernetes.pods.targets
        
        rule {
          source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_name"]
          target_label  = "app"
        }
        
        rule {
          source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_component"]
          target_label  = "component"
        }
        
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          target_label  = "namespace"
        }
        
        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          target_label  = "pod"
        }
        
        rule {
          source_labels = ["__meta_kubernetes_pod_container_name"]
          target_label  = "container"
        }
      }
      
      discovery.relabel "cadvisor" {
        targets = discovery.kubernetes.nodes.targets
        
        rule {
          source_labels = ["__address__"]
          target_label  = "__address__"
          replacement   = "kubernetes.default.svc:443"
        }
        
        rule {
          source_labels = ["__meta_kubernetes_node_name"]
          target_label  = "__metrics_path__"
          replacement   = "/api/v1/nodes/${1}/proxy/metrics/cadvisor"
        }
      }
      
      prometheus.scrape "cadvisor" {
        targets    = discovery.relabel.cadvisor.output
        forward_to = [prometheus.remote_write.default.receiver]
        scheme     = "https"
        bearer_token_file = "/var/run/secrets/kubernetes.io/serviceaccount/token"
        tls_config {
          ca_file = "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
          insecure_skip_verify = false
        }
      }
      
      loki.source.kubernetes "pods" {
        targets    = discovery.relabel.pod_labels.output
        forward_to = [loki.write.default.receiver]
      }
      
      prometheus.remote_write "default" {
        endpoint {
          url = "http://prometheus-kube-prometheus-prometheus.core-observe:9090/api/v1/write"
        }
      }
      
      loki.write "default" {
        endpoint {
          url = "http://loki-gateway.core-observe:80/loki/api/v1/push"
        }
      }

controller:
  type: daemonset

resources:
  requests:
    cpu: 100m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 512Mi
